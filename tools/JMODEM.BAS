10 CLS
20 PRINT "JMODEM by Joshua Foster"
30 PRINT "Opening COM2:300,N,8,1..."
40 DEFINT A-Z
50 DIM BUF$(132)
60 DIM FILEBUF$(16384)
70 NF=0
80 TOTALPAKS=0
90 OPEN "COM2:300,N,8,1,CS,DS,CD" AS #1
100 PRINT "Waiting for data...";
110 N=0
120 WHILE N<132
130 IF EOF(1) THEN 130
140 A$=INPUT$(LOC(1),#1)
150 FOR I=0 TO LEN(A$)
160 BUF$(N+I)=MID$(A$,I,1) 'CAN WE DO THIS BETTER?
170 NEXT I
180 N=N+I
190 WEND
200 GOSUB 300 'CHECKSUM
210 IF NOT VALID THEN PRINT "Bad packet, trying again";:PRINT #1,CHR$(21):GOTO 110 'NAK
220 PAKNUM=CVI(MID$(BUF$,1,2))
230 IF PANKUM<>TOTALPAKS THEN PRINT "Expected packet"TOTALPAKS"but received"PAKNUM!":CLOSE:END
231 FOR I=0 TO 128
232 FILEBUF$(NF+I)=MID$(BUF$,I+5,1)
239 NEXT I
240 PAKNUM=PAKNUM+1
250 NF=NF+128
260 PRINT NF"...";
270 PRINT #1,CHR$(6) 'ACK
280 END
290 REM
300 REM CHECKSUM
310 SUM=0
320 FOR I=0 TO 131
330 SUM=SUM+ASC(BUF$(I))
340 NEXT I
350 SUM=SUM MOD 256
360 VALID = SUM<>ASC(BUF(131))
370 RETURN