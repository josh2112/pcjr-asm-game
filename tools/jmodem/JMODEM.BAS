10 CLS:PRINT "JMODEM by Joshua Foster"
20 DEFINT A-Z
30 PAKSRECVD=0
40 PRINT "Opening serial port...";
50 OPEN "COM2:1200,N,8,1,CS,DS,CD" AS #1
60 PRINT "Waiting for data..."
70 OPEN "TMP.TMP" FOR OUTPUT AS #2
80 ' Receive packet
90 SBUF$=""
100 WHILE LEN(SBUF$)<134
110   IF EOF(1) THEN 110
120   SBUF$=SBUF$+INPUT$(LOC(1),#1)
130 WEND
140 ' Verify checksum
150 'GOSUB 490
155 'REM IF NOT VALID THEN PRINT "Checksum failed, trying again";:PRINT #1,CHR$(21);:GOTO 80
160 ' Verify packet number
170 PAKNUM=CVI(MID$(SBUF$,2,2))
180 TOTALPAKS=CVI(MID$(SBUF$,4,2))
190 IF PAKNUM<>PAKSRECVD THEN PRINT "Expected packet"PAKSRECVD"but received"PAKNUM"!":CLOSE:END
200 ' Copy packet data to filebuf ---
210 PRINT #2, MID$(SBUF$,6,128);
220 PAKSRECVD=PAKSRECVD+1
230 PRINT PAKSRECVD"/"TOTALPAKS"...";
240 'Ack the packet and recv the next one
250 PRINT #1,CHR$(6);
260 IF PAKSRECVD<TOTALPAKS THEN GOTO 80
270 PRINT #2, CHR$(FBUF(I));
280 CLOSE
290 PRINT "Complete!"
300 END
310 ' --- Subroutines ---
320 'Checksum()
330 SUM=0
340 FOR I=0 TO 133:SUM=SUM+SBUF(I):NEXT I
350 VALID=((SUM MOD 256)=SBUF(134))
360 RETURN
