10 CLS:PRINT "JMODEM by Joshua Foster"
20 DEFINT A-Z
40 NF=0:PAKSRECVD=0
50 PRINT "Opening serial port...";
60 OPEN "COM2:1200,N,8,1,CS,DS,CD" AS #1
70 PRINT "Waiting for data..."
80 ' Receive packet
90 SBUF$=""
100 WHILE LEN(SBUF$)<134
110   IF EOF(1) THEN 110
120   SBUF$=SBUF$+INPUT$(LOC(1),#1)
170 WEND
180 ' Verify checksum
190 REM GOSUB 490
200 REM IF NOT VALID THEN PRINT "Checksum failed, trying again";:PRINT #1,CHR$(21);:GOTO 80
210 ' Verify packet number
220 PAKNUM=CVI(MID$(SBUF$,2,2))
225 TOTALPAKS=CVI(MID$(SBUF$,4,2))
230 IF PAKNUM<>PAKSRECVD THEN PRINT "Expected packet"PAKSRECVD"but received"PAKNUM"!":CLOSE:END
260 ' Copy packet data to filebuf ---
280 PRINT #2, MID$(SBUF$,6,128);
320 PAKSRECVD=PAKSRECVD+1
330 NF=NF+128
340 PRINT NF"...";
350 'Ack the packet and recv the next one
360 PRINT #1,CHR$(6);
370 IF PAKSRECVD<TOTALPAKS THEN GOTO 80
440 CLOSE
450 PRINT "Complete!"
460 END
470 ' --- Subroutines ---
480 'Checksum()
490 SUM=0
500 FOR I=0 TO 134:SUM=SUM+SBUF(I):NEXT I
510 VALID=((SUM MOD 256)=SBUF(133))
520 RETURN
